<!DOCTYPE html>
<html>
<head>
    <title>My Portfolio Item Tree</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                !function(){var e=window.Ext4||window.Ext,t=null;e.define("Rally.apps.PortfolioItemCopy.app",{extend:"Rally.app.TimeboxScopedApp",settingsScope:"project",componentCls:"app",config:{defaultSettings:{keepTypesAligned:!0,hideArchived:!0,showFilter:!0,allowMultiSelect:!1,useColour:!1}},getSettingsFields:function(){return[{name:"allowMultiSelect",xtype:"rallycheckboxfield",fieldLabel:"Enable multiple start items (Note: Page Reload required if you change value)",labelAlign:"top"},{xtype:"rallycheckboxfield",fieldLabel:"Show Advanced filter",name:"showFilter",labelAlign:"top"}]},itemId:"rallyApp",STORE_FETCH_FIELD_LIST:["Name","FormattedID","Parent","DragAndDropRank","Children","ObjectID","Project","DisplayColor","Owner","Blocked","BlockedReason","Ready","Tags","Workspace","RevisionHistory","CreationDate","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate","PredecessorsAndSuccessors","State","PreliminaryEstimate","Description","Notes","Predecessors","Successors","OrderIndex","PortfolioItemType","Ordinal","Release","Iteration","Milestones","c_ProjectIDOBN","c_QRWP","c_ProgressUpdate","c_RAIDSeverityCriticality","c_RISKProbabilityLevel","c_RAIDRequestStatus"],items:[{xtype:"container",itemId:"filterBox"},{xtype:"container",itemId:"selectionBox",listeners:{afterrender:function(){(t=this.up("#rallyApp"))._onElementValid(this)}}}],timer:null,_resetTimer:function(e){t.timer&&clearTimeout(t.timer),t.timer=setTimeout(e,2e3)},_nodeTree:null,_enterMainApp:function(){var e=t._createTree(t._nodes);t._nodeTree=e,t._refreshTree()},_refreshTree:function(){},_onElementValid:function(e){t.timeboxScope=t.getContext().getTimeboxScope();var o={xtype:"container",itemId:"headerBox",layout:"hbox",items:[{xtype:"rallyportfolioitemtypecombobox",itemId:"piType",fieldLabel:"Choose Portfolio Type :",labelWidth:100,margin:"5 0 5 20",defaultSelectionPosition:"first",listeners:{select:function(){t._kickOff()}}}]};this.insert(0,o)},_nodes:[],onSettingsUpdate:function(){t._nodes&&(t._nodes=[]),t._getArtifacts(t.down("#itemSelector").valueModels)},onTimeboxScopeChange:function(e){this.callParent(arguments),t.timeboxScope=e,t._nodes&&(t._nodes=[]),t._getArtifacts([t.down("#itemSelector").getRecord()])},_onFilterChange:function(e){t.advFilters=e.getTypesAndFilters().filters,e._previousTypesAndFilters=e.getTypesAndFilters(),t._nodes.length&&(t._nodes=[],t._getArtifacts([t.down("#itemSelector").getRecord()]))},_onFilterReady:function(e){t.down("#filterBox").add(e)},_kickOff:function(){var o=t.down("#piType"),r=t.down("#headerBox");t._typeStore=o.store;var n=t.down("#itemSelector");n&&n.destroy();r.insert(2,{xtype:"rallyartifactsearchcombobox",fieldLabel:"Choose Start Item :",itemId:"itemSelector",multiSelect:t.getSetting("allowMultiSelect"),labelWidth:100,queryMode:"remote",allowNoEntry:!1,pageSize:200,width:600,margin:"10 0 5 20",stateful:!0,stateId:this.getContext().getScopedStateId("itemSelector"),storeConfig:{models:["portfolioitem/"+o.rawValue],fetch:t.STORE_FETCH_FIELD_LIST,context:t.getContext().getDataContext(),pageSize:200,autoLoad:!0},listeners:{change:function(e,o){o&&o.length>0&&t._resetTimer(this.startAgain)}},startAgain:function(){var e=t.down("#itemSelector").valueModels;t._nodes&&(t._nodes=[]),e&&e.length>1&&t._nodes.push({Name:"Combined View",record:{data:{_ref:"root",Name:""}},local:!0}),t._getArtifacts(e)}});t.getSetting("showFilter")&&!t.down("#inlineFilter")&&r.add({xtype:"rallyinlinefiltercontrol",name:"inlineFilter",itemId:"inlineFilter",margin:"10 0 5 20",context:this.getContext(),height:26,inlineFilterButtonConfig:{stateful:!0,stateId:this.getContext().getScopedStateId("inline-filter"),context:this.getContext(),modelNames:t._getModelFromOrd(0),filterChildren:!1,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch","Owner"]}},listeners:{inlinefilterchange:this._onFilterChange,inlinefilterready:this._onFilterReady,scope:this}}}),t.down("#infoButton")||r.add({xtype:"rallybutton",itemId:"infoButton",margin:"10 0 5 20",align:"right",text:"Page Info",handler:function(){e.create("Rally.ui.dialog.Dialog",{autoShow:!0,draggable:!0,closable:!0,width:500,autoScroll:!0,maxHeight:600,title:"Information about this app",items:{xtype:"component",html:'<p class="boldText">Hierarchical Tree View</p><p>This app will find all the children of a particular Portfolio artefact. You can choose the type of artefact, then the top level artefact itself.</p><p>The colours of the circles indicate the state of progress from red (those that are not started), through to blue (in their final stages). Click on the "Colour Codes" button to see the colour to state mapping for each portfolio item type.</p><p class="boldText">Choosing collections</p><p>The app settings contains an option to allow you to multi-select the top level artefacts. This allows you to choose a number of portfolio items of interest and then filter for the features</p><p class="boldText">Visualising Dependencies</p><p>The edge of the circle will be red if there are any dependencies (predecessors or successors) and the colour of the associated text will indicate those with predecessors (red text) and those with successors (green text). Those with both will appear as having predecessors</p><p>If the text is blinking, it means that the relevant dependency is not being shown in this data set. </p><p class="boldText">Exploring the data</p><p>You can investigate dependencies by using &lt;shift&gt;-Click on the circle. This will call up an overlay with the relevant dependencies. Clicking on the FormattedID on any artefact in the overlay will take you to it in either the EDP or QDP page (whichever you have enabled for your session )</p><p>If you click on the circle without using shift, then a data panel will appear containing more information about that artefact</p><p class="boldText">Filtering</p><p>There are app settings to enable the extra filtering capabilities on the main page, so that you can choose which lowest-level portfolio items to see e.g. filter on Owner, Investment Type, etc. </p><p>To filter by release (e.g. to find all those features scheduled into a Program Increment) you will need to edit the Page settings (not the App Settings) to add a Release or Milestone filter</p><p>Source code available here: <br/><a href=https://github.com/nikantonelli/PortfolioItem-Tree-With-Dependencies> Github Repo</a></p>',padding:10}})}})},_getArtifacts:function(o){t._nodes=t._nodes.concat(t._createNodes(o)),_.each(o,function(o){if(o.hasField("Children")&&!o.data._ref.includes("hierarchicalrequirement")){var r={sorters:[{property:"DragAndDropRank",direction:"ASC"}],fetch:t.STORE_FETCH_FIELD_LIST,callback:function(e,o,r){r&&e&&e.length&&t._getArtifacts(e)},filters:[]};t.getSetting("hideArchived")&&r.filters.push({property:"Archived",operator:"=",value:!1}),t.getSetting("showFilter")&&t.advFilters&&t.advFilters.length>0&&e.Array.each(t.advFilters,function(e){r.filters.push(e)}),o.getCollection("Children").load(r)}else{r={sorters:[{property:"DragAndDropRank",direction:"ASC"}],fetch:t.STORE_FETCH_FIELD_LIST,callback:function(e,o,r){r&&e&&e.length&&t.getSetting("includeStories")&&(t._nodes=t._nodes.concat(t._createNodes(e)),t.fireEvent("refreshTree"))}};if(o.hasField("UserStories"))r.fetch.push(t._getModelFromOrd(0).split("/").pop()),o.getCollection("UserStories").load(r);else{if(o.hasField("Tasks")&&o.getCollection("Tasks").load(r),o.hasField("Defects")){var n={sorters:[{property:"DragAndDropRank",direction:"ASC"}],fetch:t.STORE_FETCH_FIELD_LIST,callback:function(e,o,r){r&&e&&e.length&&(t._nodes=t._nodes.concat(t._createNodes(e)),t.fireEvent("refreshTree"))}};o.getCollection("Defects").load(n)}if(o.hasField("TestCases")){var i={sorters:[{property:"DragAndDropRank",direction:"ASC"}],fetch:t.STORE_FETCH_FIELD_LIST,callback:function(e,o,r){r&&e&&e.length&&(t._nodes=t._nodes.concat(t._createNodes(e)),t.fireEvent("refreshTree"))}};o.getCollection("TestCases").load(i)}}}})},_createNodes:function(e){var o=[];return _.each(e,function(e){var r=t.getContext().getProjectRef()===e.get("Project")._ref;o.push({Name:e.get("FormattedID"),record:e,local:r,dependencies:[]})}),o},_findNode:function(e,t){var o=null;return _.each(e,function(e){e.record&&e.record.data._ref===t._ref&&(o=e)}),o},_findParentType:function(e){for(var o=null,r=0;r<t._typeStore.totalCount;r++)if(e.data._type===t._typeStore.data.items[r].get("TypePath").toLowerCase()){o=t._typeStore.data.items[r].get("Ordinal");break}if(o+=1,r>=t._typeStore.totalCount)return null;var n=_.find(t._typeStore.data.items,function(e){return e.get("Ordinal")===o});return n&&n.get("TypePath").toLowerCase()},_findNodeById:function(e,t){return _.find(e,function(e){return e.record.data._ref===t})},_findParentNode:function(e,o){if("root"===o.record.data._ref)return null;var r=o.record.data.Parent,n=null;if(r)n=t._findNode(e,r);else{var i=t._findParentType(o.record);if(i){var a="/"+i+"/null";n=t._findNodeById(e,a)}}return n||t._findNodeById(e,"root")},_getSelectedOrdinal:function(){return t.down("#piType").lastSelection[0].get("Ordinal")},_getTypeList:function(e){var o=[];return _.each(t._typeStore.data.items,function(t){t.data.Ordinal<=(e||0)&&o.push({type:t.data.TypePath.toLowerCase(),Name:t.data.Name,ref:t.data._ref,Ordinal:t.data.Ordinal})}),o},_highestOrdinal:function(){return _.max(t._typeStore.data.items,function(e){return e.get("Ordinal")}).get("Ordinal")},_getModelFromOrd:function(e){var o=null;return _.each(t._typeStore.data.items,function(t){e==t.get("Ordinal")&&(o=t)}),o&&o.get("TypePath")},_getOrdFromModel:function(e){var o=null;return _.each(t._typeStore.data.items,function(t){e==t.get("TypePath").toLowerCase()&&(o=t.get("Ordinal"))}),o},_createTree:function(e){return d3.stratify().id(function(e){return e.record&&e.record.data._ref||null}).parentId(function(o){var r=t._findParentNode(e,o);return r&&r.record&&r.record.data._ref})(e)},refetchTree:function(){t._enterMainApp()},_getNodeId:function(t){return"root"===t.data.record.data._ref?e.id():t.data.record?t.data.record.get("FormattedID"):e.id()},launch:function(){this.on("refetchTree",this.refetchTree)},initComponent:function(){this.callParent(arguments),this.addEvents("refetchTree")}})}();

            Rally.launchApp('Rally.apps.PortfolioItemCopy.app', {
                name:"My Portfolio Item Tree",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .node text{font:14px sans-serif}.info--box text{font-size:14px;font-family:"ProximaNovaSemiBold,Helvetica,Arial"}.node--internal text{text-shadow:0 1px 0 #fff,0 -1px 0 #fff,1px 0 0 #fff,-1px 0 0 #fff}.local--link{fill:none;stroke:#111;stroke-opacity:0.4;stroke-width:1.5px}.remote--link{fill:none;stroke:#ddd;stroke-opacity:0.4;stroke-width:1.5px}.invisible--link{fill:none;stroke:#ddd;stroke-opacity:0.0;stroke-width:1.5px}.predecessor--link{fill:dashed;stroke:lightblue;stroke-opacity:0.5;stroke-width:3px}.error--node{fill:#000}.data--errors{stroke:#f00;stroke-width:3px}.no--errors{stroke:#111;stroke-width:2px}.no--errors--not--started{fill:#00ffff;stroke:#111;stroke-width:2px}.no--errors--in--progress{fill:#0f0;stroke:#00f;stroke-width:2px}.dotOutline{stroke:#000;stroke-width:2px}.gotDependencies{stroke:#f00;stroke-width:2px;fill:#ff0000}.gotSuccText{fill:#888800}.gotPredText{fill:#ff0000}.boldText{font-weight:bold}.RAID-blue{border-radius:10px;border:2px solid black;height:20px;width:20px;background-color:#145FAC}.RAID-red{border-radius:10px;border:2px solid black;height:20px;width:20px;background-color:#ff005c}.RAID-amber{border-radius:10px;border:2px solid black;background-color:#f3ca5e;height:20px;width:20px}.RAID-green{border-radius:10px;border:2px solid black;height:20px;width:20px;background:#b3ee01}.q0-3{fill:#fc8d59}.q1-3{fill:#ffffbf}.q2-3{fill:#91bfdb}.q0-4{fill:#d7191c}.q1-4{fill:#fdae61}.q2-4{fill:#abd9e9}.q3-4{fill:#2c7bb6}.q0-5{fill:#d7191c}.q1-5{fill:#fdae61}.q2-5{fill:#ffffbf}.q3-5{fill:#abd9e9}.q4-5{fill:#2c7bb6}.q0-6{fill:#d73027}.q1-6{fill:#fc8d59}.q2-6{fill:#fee090}.q3-6{fill:#e0f3f8}.q4-6{fill:#91bfdb}.q5-6{fill:#4575b4}.q0-7{fill:#d73027}.q1-7{fill:#fc8d59}.q2-7{fill:#fee090}.q3-7{fill:#ffffbf}.q4-7{fill:#e0f3f8}.q5-7{fill:#91bfdb}.q6-7{fill:#4575b4}.q0-8{fill:#d73027}.q1-8{fill:#f46d43}.q2-8{fill:#fdae61}.q3-8{fill:#fee090}.q4-8{fill:#e0f3f8}.q5-8{fill:#abd9e9}.q6-8{fill:#74add1}.q7-8{fill:#4575b4}.q0-9{fill:#d73027}.q1-9{fill:#f46d43}.q2-9{fill:#fdae61}.q3-9{fill:#fee090}.q4-9{fill:#ffffbf}.q5-9{fill:#e0f3f8}.q6-9{fill:#abd9e9}.q7-9{fill:#74add1}.q8-9{fill:#4575b4}@keyframes textBlink{50%{opacity:0.5}}@-webkit-keyframes textBlink{50%{opacity:0.5}}.textBlink{animation:textBlink 1s step-start 0s infinite;-webkit-animation:textBlink 1s step-start 0s infinite}.RAID-missing-severity{border-radius:10px;border:2px solid red;height:20px;width:20px;background-color:white;background:linear-gradient(#fff 50%, #f00 50%);background-size:20% 100%;background-repeat:repeat-x}.RAID-missing-probability{border-radius:10px;border:2px solid red;height:20px;width:20px;background-color:white;background:linear-gradient(#f00 50%, #fff 50%);background-size:20% 100%;background-repeat:repeat-x}.RAID-missing-severity-probability{border-radius:10px;border:2px solid red;height:20px;width:20px;background-color:white}
    </style>
</head>
<body>
</body>
</html>
